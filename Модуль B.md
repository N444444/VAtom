## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
- –ó–∞–¥–∞–Ω–∏—è –Ω–∞–ø–∏—Å–∞–Ω—ã –Ω–µ –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ.
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è.
- –í–µ–∑–¥–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å P@ssw0rd, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–≥–æ.
- –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–≤–æ–∏—Ö —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö/–∞–¥—Ä–µ—Å–æ–≤/DNS –∏–º–µ–Ω, —ç—Ç–æ –∑–∞–Ω–æ—Å–∏—Ç—Å—è –≤ —á–µ—Ä–Ω–æ–≤–∏–∫ –∫–æ—Ç–æ—Ä—ã–π –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ.
- –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è - –±–∞–ª–ª—ã –Ω–µ –¥–∞—é—Ç—Å—è.
## –õ–µ–≥–µ–Ω–¥–∞ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -  –•–æ–ª–¥–∏–Ω–≥ "CoolCompany", –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –∞—É–¥–∏—Ç–æ–º —Å–∏—Å—Ç–µ–º –ò–ë –∏ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç - "Afisha Today". –≠—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –º–∞–ª—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –∏ —á–∞—Å—Ç–Ω—ã—Ö –ª–∏—Ü –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–π –∏ –¥–æ—Å—É–≥–∞. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∑–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–º–∏—Å—Å–∏—é —Ä–∞–∑–º–µ—â–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–æ–º —Ä–µ—Å—É—Ä—Å–µ. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π —Å–ª—É—à–∞—Ç–µ–ª–µ–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–º —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π. 

–ö–æ–º–ø–∞–Ω–∏—è –∏–º–µ–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Å—Ç–æ–π–∫—É –≤ –¶–û–î, –æ—Ñ–∏—Å –≤ –ú–æ—Å–∫–≤–µ, –∞—Ä–µ–Ω–¥—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã –≤ –ø—É–±–ª–∏—á–Ω–æ–º –æ–±–ª–∞–∫–µ "Cloud Happy" –∞ —Ç–∞–∫–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞ –ø–æ–∫—É–ø–∫—É  –ì–ö "–ú–∏–Ω–µ—Ä–∞–ª—ã –£—Ä–∞–ª–∞"  - –≤—Å—è –ò–¢-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ä–Ω–æ–¥–æ–±—ã–≤–∞—é—â–∏–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –µ—ë –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–µ—Ä–µ—à–ª–∏ –ø–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å "CoolCompany". –†–∞–Ω–µ–µ –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ "–ú–∏–Ω–µ—Ä–∞–ª—ã –£—Ä–∞–ª–∞" —Ä–∞–±–æ—Ç–∞–ª–∞ –¥—Ä—É–≥–∞—è –ò–¢-–∫–æ–º–ø–∞–Ω–∏—è –∏ –Ω–µ –æ—Å—Ç–∞–≤–∏–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ—Å–ª–µ —Å–µ–±—è. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É.

| –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã | –í–µ—Ä—Å–∏—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã | –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã                               |
| ------------------------------- | --------------------------- | ------------------------------------------ |
| DC-K8S                          | Ubuntu 24.04                | –ù–µ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä                       |
| DC-MAILSERVER                   | Debian 12                   | –ù–µ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä                       |
| DC-STORAGE                      | Debian 12                   | –ù–µ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä                       |
| DC-RTR-2                        | Debian 12                   | –ù–µ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä                       |
| DC-RTR-1                        | Debian 12                   | –ù–µ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä                       |
| REMOTE-TERMINAL                 | Astra Linux 1.7             | –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–ª–∏–µ–Ω—Ç, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ‚Äú–í–æ—Ä–æ–Ω–µ–∂‚Äù |
| MOOGLE                          | –£—á–∞—Å—Ç–Ω–∏–∫—É –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω        | –£—á–∞—Å—Ç–Ω–∏–∫—É –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω                       |
| AZAZON                          | –£—á–∞—Å—Ç–Ω–∏–∫—É –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω        | –£—á–∞—Å—Ç–Ω–∏–∫—É –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω                       |
| REPO-MIRROR                     | –£—á–∞—Å—Ç–Ω–∏–∫—É –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω        | –£—á–∞—Å—Ç–Ω–∏–∫—É –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω                       |
| CLOUD-VM                        | Debian 12                   | –ù–µ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä                       |
| MSK-RTR                         | Debian 12                   | –ù–µ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä                       |
| MSK-DC                          | Astra Linux 1.7             | –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ‚Äú–í–æ—Ä–æ–Ω–µ–∂‚Äù |
| MSK-ADMINPC                     | Astra Linux 1.7             | –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–ª–∏–µ–Ω—Ç, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ‚Äú–í–æ—Ä–æ–Ω–µ–∂‚Äù |
| MSK-WORKER                      | Astra Linux 1.7             | –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–ª–∏–µ–Ω—Ç, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ‚Äú–í–æ—Ä–æ–Ω–µ–∂‚Äù |
| MSK-GITLAB                      | Debian 12                   | –ù–µ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä                       |
| YEKT-RTR                        | Debian 12                   | –ù–µ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä                       |
| YEKT-BILLING                    | Astra Linux 1.7             | –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ‚Äú–í–æ—Ä–æ–Ω–µ–∂‚Äù |
| YEKT-DB                         | Astra Linux 1.7             | –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ‚Äú–í–æ—Ä–æ–Ω–µ–∂‚Äù |
| YEKT-WORKER                     | Astra Linux 1.7             | –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–ª–∏–µ–Ω—Ç, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ‚Äú–í–æ—Ä–æ–Ω–µ–∂‚Äù |
REPO-MIRROR —ç—Ç–æ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä, —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏: 
- Debian 12 (mirror.yandex.ru), 
- Ubuntu 24.04 (mirror.yandex.ru), 
- Astra Linux 1.7 (dl.astralinux.ru).

–í –∑–∞–¥–∞–Ω–∏–∏ –≤—ã—Ö–æ–¥ –≤ ‚Äú–Ω–∞—Å—Ç–æ—è—â–∏–π‚Äù –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω, —Å–∏—Å—Ç–µ–º–∞ —ç–º—É–ª–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, –Ω–æ –Ω–∞–ø—Ä—è–º—É—é –≤—ã—Ö–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
## **–†–∞–±–æ—Ç—ã –≤ –¶–û–î**

### 1. –ù–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –Ω–∞ —Ç–æ–ø–æ–ª–æ–≥–∏–∏, —Å–æ–∑–¥–∞–π—Ç–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ L3-–∞–¥—Ä–µ—Å–∞.
![[–¢–æ–ø–æ–ª–æ–≥–∏—è L3.png]]
#### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è? 
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å IP –∞–¥—Ä–µ—Å–∞ –∏ –º–∞—Å–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–∫–≤–∞–¥—Ä–∞—Ç—ã —Å —á–∏—Å–ª–∞–º–∏ –æ–∑–Ω–∞—á–∞—é—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–∏—Ñ—Ä—É –∞–¥—Ä–µ—Å–∞).
#### –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
–ï—Å–ª–∏ —É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ–¥–∏–Ω ip –∞–¥—Ä–µ—Å, —Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:
```
sudo ip addr add –ê–î–†–ï–°/–ú–ê–°–ö–ê dev eth0
```
–ü–æ—Å–ª–µ —á–µ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ç—å:
```
sudo systemctl restart networking
```

–ï—Å–ª–∏ –∞–¥—Ä–µ—Å–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ, –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –≤—ã—à–µ –º–µ–Ω—è—è –∞–¥—Ä–µ—Å, –º–∞—Å–∫—É –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ç—å. 

–ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–¥–∏–Ω, —Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º VLAN-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ç—å, –ø—Ä–∏–º–µ—Ä:
```
ip addr add 31.18.10.10/24 dev eth0.10             #VLAN 10 
ip addr add 100.200.100.10/24 dev eth0.20          #VLAN 20 
ip addr add 188.121.90.1/30 dev eth0.30            #VLAN 30
```
### 2. –í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º DC-STORAGE) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É SSH –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç–∏ –ø–æ –ª–æ–≥–∏–Ω—É - cod_admin.
#### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è? 
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ SSH –∫–æ –≤—Å–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º –∫—Ä–æ–º–µ DC-STORAGE.
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å **–ø–æ SSH-–∫–ª—é—á—É** (–±–µ–∑ –ø–∞—Ä–æ–ª—è) —Å –ª–æ–≥–∏–Ω–æ–º **cod_admin**.
- –î–æ—Å—Ç—É–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **—Ç–æ–ª—å–∫–æ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç–∏**.
- SSH-–∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ **DC-STORAGE** –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `/ssh_keys`. –î–æ—Å—Ç—É–ø–∞ –∫ DC-STORAGE —á–µ—Ä–µ–∑ OpenConnect —Å –ª–æ–≥–∏–Ω–æ–º cod_admin –∏ –ø–∞—Ä–æ–ª–µ–º At0mSk1lls.
#### –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ DC-STORAGE –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ –ø–∞–∫–µ—Ç `openssh-server`:
```
dpkg -l | grep openssh-server
```

–ï—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:
```
sudo apt update
sudo apt install openssh-server
```

–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—É:
```
sudo systemctl start ssh
```

–ò –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫:
```
sudo systemctl enable ssh
```

–ï—Å–ª–∏ –≤—Å—ë —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –≤—ã–ø–æ–ª–Ω—è–µ–º[[–°–æ–∑–¥–∞–Ω–∏–µ ssh –∫–ª—é—á–∞ | –∫–æ–º–∞–Ω–¥—É —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞]]:
```
mkdir -p /ssh_keys
ssh-keygen -t ed25519 -f /ssh_keys/cod_admin_key -N ""
```

–°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `cod_admin` –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö ([[–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | —Ç—ã–∫]])
```
sudo useradd -m -s /bin/bash cod_admin
sudo mkdir -p /home/cod_admin/.ssh
sudo touch /home/cod_admin/.ssh/authorized_keys
sudo chmod 700 /home/cod_admin/.ssh
sudo chmod 600 /home/cod_admin/.ssh/authorized_keys
sudo chown -R cod_admin:cod_admin /home/cod_admin/.ssh
```

–°–æ–∑–¥–∞—ë–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤—Å–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∏ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞:
```
for server in 192.168.1.2 192.168.1.3 10.15.10.200; do
	# –°–æ–∑–¥–∞—ë–º .ssh –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–µ—Å–ª–∏ –Ω–µ—Ç)
    ssh cod_admin@$server "mkdir -p /home/cod_admin/.ssh"

    # –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
    scp /ssh_keys/cod_admin_key cod_admin@$server:/home/cod_admin/.ssh/id_rsa

    # –ö–æ–ø–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã)
	scp /ssh_keys/cod_admin_key.pub cod_admin@$server:/home/cod_admin/.ssh/id_rsa.pub

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
    ssh cod_admin@$server "
      chmod 700 /home/cod_admin/.ssh && \
      chmod 600 /home/cod_admin/.ssh/id_rsa && \
      chmod 644 /home/cod_admin/.ssh/id_rsa.pub && \
      chown -R cod_admin:cod_admin /home/cod_admin/.ssh
    "
done
```

–ù–∞ –º–∞—à–∏–Ω–∞—Ö –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ SSH:
```
sudo nano /etc/ssh/sshd_config
```
–î–æ–±–∞–≤–ª—è–µ–º:
```
# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º)
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AllowUsers cod_admin

# –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö IP-–∞–¥—Ä–µ—Å–æ–≤
Match Address 192.168.1.0/24,10.15.10.0/24
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º SSH:
```
sudo systemctl restart ssh
```

–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º `/etc/ssh/sshd_config` –Ω–∞ DC-STORAGE:
```
# –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Match
Match all
# –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –∑–∞–ø—Ä–µ—Ç–∏—Ç—å —Ä—É—Ç, etc.
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication yes

# –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∏–∑ VPN
Match Address 10.8.0.0/24 User cod_admin
    PasswordAuthentication yes
    PubkeyAuthentication no
    # –ó–¥–µ—Å—å –º—ã –≥–æ–≤–æ—Ä–∏–º: –≤—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é —Ä–∞–∑—Ä–µ—à—ë–Ω, –ø–æ –∫–ª—é—á—É ‚Äî –Ω–µ—Ç.
    
# –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –¥–æ—Å—Ç—É–ø –≤—Å–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–º
Match all
    PasswordAuthentication no
```

–ò–∑–º–µ–Ω–∏–º –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ DC-STORAGE::
```
echo "cod_admin:At0mSk1lls" | sudo chpasswd
```
### 3. –ú–µ–∂–¥—É DC-RTR-2,DC-RTR-1,MSK-RTR,YEKT-RTR –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —É–¥–∞–ª—ë–Ω–Ω—ã–π –∑–∞—â–∏—â—ë–Ω–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å.
#### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è? 
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∑–∞—â–∏—Ç–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å –º–µ–∂–¥—É —á–µ—Ç—ã—Ä—å–º—è —Ç–æ—á–∫–∞–º–∏:
	- **DC-RTR-1 ‚Üî MSK-RTR** (–û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –¥–ª—è –ú–æ—Å–∫–≤—ã)
	- **DC-RTR-2 ‚Üî YEKT-RTR** (–û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –¥–ª—è –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞)
	- **DC-RTR-1 ‚Üî YEKT-RTR** (–†–µ–∑–µ—Ä–≤ –¥–ª—è –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞)
	- **DC-RTR-2 ‚Üî MSK-RTR** (–†–µ–∑–µ—Ä–≤ –¥–ª—è –ú–æ—Å–∫–≤—ã)
- –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤—è–∑–∏ –ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –æ—Ñ–∏—Å–∞ –¥–æ –¶–û–î, —Ç–æ –∑–∞–º–µ–Ω–∞ –Ω–∞ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—Å–∫–∏–π –æ—Ñ–∏—Å –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç. 
- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–µ—Å–ø–µ—Ä–µ–±–æ–π–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ —Å–≤—è–∑–∏ –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤.
- –û—Å–Ω–æ–≤–Ω–æ–µ –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã.
![[–¢–æ–ø–æ–ª–æ–≥–∏—è VPN.png]]
#### –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WireGuard –Ω–∞ –∫–∞–∂–¥–æ–º –∏–∑ 4-—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤:
```
sudo apt update
sudo apt install -y wireguard

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏
wg --version
```

–ï—Å–ª–∏ WireGuard –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –ø–∞–∫–µ—Ç–æ–≤, —Ç–æ –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å REPO-MIRROR.
–ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä—É –æ–¥–Ω–æ–π –∏–∑ –∫–æ–º–∞–Ω–¥:
```
ping REPO-MIRROR
curl -I http://REPO-MIRROR
wget --spider http://REPO-MIRROR
curl -I http://REPO-MIRROR/debian/dists/bookworm/Release
```
–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤:
```
sudo nano /etc/apt/sources.list
```
–î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è Debian:
```
deb http://REPO-MIRROR/debian bookworm main contrib non-free
deb http://REPO-MIRROR/debian bookworm-updates main contrib non-free
deb http://REPO-MIRROR/debian-security bookworm-security main contrib non-free
```
–î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è Astra:
```
deb http://REPO-MIRROR/astra stable main contrib non-free
```
–ü–æ—Å–ª–µ —á–µ–≥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
```
sudo apt update
```

–ó–∞–∫–æ–Ω—á–∏–≤ —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π, —Å–æ–∑–¥–∞—ë–º –Ω–∞ –∫–∞–∂–¥–æ–º —Ä–æ—É—Ç–µ—Ä–µ –ø—É–±–ª–∏—á–Ω—ã–π –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á:
```
wg genkey | tee /etc/wireguard/private.key | wg pubkey > /etc/wireguard/public.key

sudo chmod 600 /etc/wireguard/private.key
```

–ü–µ—Ä–µ–¥–∞—ë–º –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –∏ —Å–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `/etc/wireguard/wg0.conf` –∏ `/etc/wireguard/wg1.conf`
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: 
**DC-RTR-1**
wg0
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_DC-RTR-1>
Address = 10.100.0.3/24
ListenPort = 51820

# –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å: DC-RTR-1 <-> YEKT-RTR
[Peer]
PublicKey = <–ü–£–ë–õ–ò–ß–ù–´–ô_–ö–õ–Æ–ß_YEKT-RTR>
Endpoint = <IP_YEKT-RTR>:51820
AllowedIPs = 10.100.0.2/32, 192.168.1.0/24 # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç—É–Ω–µ–ª—é –∏ –¶–û–î
PersistentKeepalive = 25
```
wg1
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_DC-RTR-1>
Address = 10.200.0.3/24
ListenPort = 51821

# –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å: DC-RTR-1 <-> MSK-RTR
[Peer]
PublicKey = <–ü–£–ë–õ–ò–ß–ù–´–ô_–ö–õ–Æ–ß_MSK-RTR>
Endpoint = <IP_MSK-RTR>:51820
AllowedIPs = 10.200.0.1/32, 192.168.1.0/24 # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç—É–Ω–µ–ª—é –∏ –¶–û–î
PersistentKeepalive = 25
```
**DC-RTR-2**
wg0
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_DC-RTR-2>
Address = 10.100.0.4/24
ListenPort = 51820

# –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å: DC-RTR-2 <-> MSK-RTR
[Peer]
PublicKey = <–ü–£–ë–õ–ò–ß–ù–´–ô_–ö–õ–Æ–ß_MSK-RTR>
Endpoint = <IP_MSK-RTR>:51820
AllowedIPs = 10.100.0.1/32, 192.168.1.0/24 # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç—É–Ω–µ–ª—é –∏ –¶–û–î
PersistentKeepalive = 25
```
wg1
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_DC-RTR-2>
Address = 10.200.0.4/24
ListenPort = 51821

# –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å: DC-RTR-2 <-> YEKT-RTR
[Peer]
PublicKey = <–ü–£–ë–õ–ò–ß–ù–´–ô_–ö–õ–Æ–ß_YEKT-RTR>
Endpoint = <IP_YEKT-RTR>:51820
AllowedIPs = 10.200.0.2/32, 192.168.1.0/24 # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç—É–Ω–µ–ª—é –∏ –¶–û–î
PersistentKeepalive = 25
```
**MSK-RTR**
wg0
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_MSK-RTR>
Address = 10.100.0.1/24
ListenPort = 51820

# –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å: DC-RTR-2 <-> MSK-RTR
[Peer]
PublicKey = <–ü–£–ë–õ–ò–ß–ù–´–ô_–ö–õ–Æ–ß_DC-RTR-2>
Endpoint = <IP_DC-RTR-2>:51820
AllowedIPs = 10.100.0.4/32, 192.168.1.0/24 # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç—É–Ω–µ–ª—é –∏ –¶–û–î
PersistentKeepalive = 25
```
wg1
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_MSK-RTR>
Address = 10.200.0.1/24
ListenPort = 51821

# –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å: DC-RTR-2 <-> YEKT-RTR
[Peer]
PublicKey = <–ü–£–ë–õ–ò–ß–ù–´–ô_–ö–õ–Æ–ß_YEKT-RTR>
Endpoint = <IP_YEKT-RTR>:51820
AllowedIPs = 10.200.0.2/32, 192.168.1.0/24 # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç—É–Ω–µ–ª—é –∏ –¶–û–î
PersistentKeepalive = 25
```
**YEKT-RTR**
wg0
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_YEKT-RTR>
Address = 10.100.0.2/24
ListenPort = 51820

# –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å: DC-RTR-1 <-> YEKT-RTR
[Peer]
PublicKey = <–ü–£–ë–õ–ò–ß–ù–´–ô_–ö–õ–Æ–ß_DC-RTR-1>
Endpoint = <IP_DC-RTR-1>:51820
AllowedIPs = 10.100.0.3/32, 192.168.1.0/24 # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç—É–Ω–µ–ª—é –∏ –¶–û–î
PersistentKeepalive = 25
```
wg1
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_YEKT-RTR>
Address = 10.200.0.2/24
ListenPort = 51821

# –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å: DC-RTR-2 <-> MSK-RTR
[Peer]
PublicKey = <–ü–£–ë–õ–ò–ß–ù–´–ô_–ö–õ–Æ–ß_MSK-RTR>
Endpoint = <IP_MSK-RTR>:51820
AllowedIPs = 10.200.0.1/32, 192.168.1.0/24 # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç—É–Ω–µ–ª—é –∏ –¶–û–î
PersistentKeepalive = 25
```

–ü–æ—Å–ª–µ **–∑–∞–ø—É—Å–∫–∞–µ–º WireGuard** –Ω–∞ –∫–∞–∂–¥–æ–º —Ä–æ—É—Ç–µ—Ä–µ:
```
sudo systemctl enable wg-quick@wg0
sudo systemctl start wg-quick@wg0

sudo systemctl enable wg-quick@wg1
sudo systemctl start wg-quick@wg1
```

–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:
```
wg show
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ OSPF –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è:
```
sudo apt update
sudo apt install -y frr
# –í–æ –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–±—Ä–∞—Ç—å zebra –∏ ospfd
```

**–í–∫–ª—é—á–∏–º –¥–µ–º–æ–Ω—ã**:
```
sudo nano /etc/frr/daemons
# zebra=yes
# ospfd=yes

sudo systemctl restart frr
```

**–ù–∞—Å—Ç—Ä–æ–∏—Ç—å /etc/frr/frr.conf**. 
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ - [[–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è FRR |—Ç—ã–∫]]):
!!!–í–∞–∂–Ω–æ, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –∫–∞–∫–æ–º eth –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ LAN.
**DC-RTR-1**
```
frr defaults traditional
hostname DC-RTR-1
log file /var/log/frr.log

router ospf
  ospf router-id 1.1.1.1
  network 10.100.0.0/24 area 0  # –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å (MSK)
  network 10.200.0.0/24 area 0  # –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å (YEKT)
  network 192.168.1.0/24 area 0 # –°–µ—Ç—å –¶–û–î —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–µ—á–∞—Ç–∏
  passive-interface eth0        # –û—Ç–∫–ª—é—á–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É Hello –ø–∞–∫–µ—Ç–æ–≤ –≤ LAN

interface wg0
  ip ospf cost 10             # YEKT –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
  ip ospf hello-interval 10   # –ö–æ–ª-–≤–æ —Å–µ–∫. –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ Hello –ø–∞–∫–µ—Ç–∞
  ip ospf dead-interval 40    # –ö–æ–ª-–≤–æ —Å–µ–∫. –¥–æ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
  ip ospf retransmit-interval 5 # –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫. –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–∞–∫–µ—Ç

interface wg1
  ip ospf priority 0          # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ö–∞–æ—Ç–∏—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
  ip ospf cost 50             # MSK —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
  ip ospf hello-interval 10   # –ö–æ–ª-–≤–æ —Å–µ–∫. –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ Hello –ø–∞–∫–µ—Ç–∞
  ip ospf dead-interval 40    # –ö–æ–ª-–≤–æ —Å–µ–∫. –¥–æ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
  ip ospf retransmit-interval 5 # –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫. –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–∞–∫–µ—Ç
  
line vty
```
DC-RTR-2
```
frr defaults traditional
hostname DC-RTR-2
log file /var/log/frr.log

router ospf
  ospf router-id 1.1.1.2
  network 10.100.0.0/24 area 0  # –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å (MSK)
  network 10.200.0.0/24 area 0  # –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å (YEKT)
  network 192.168.1.0/24 area 0 # –°–µ—Ç—å –¶–û–î —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–µ—á–∞—Ç–∏
  passive-interface eth0        # –û—Ç–∫–ª—é—á–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É Hello –ø–∞–∫–µ—Ç–æ–≤ –≤ LAN

interface wg0
  ip ospf cost 10            # –û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç –∫ MSK-RTR
  ip ospf hello-interval 10
  ip ospf dead-interval 40

interface wg1
  ip ospf priority 0
  ip ospf cost 50            # YEKT —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
  ip ospf hello-interval 10
  ip ospf dead-interval 40

line vty
```
MSK-RTR
```
frr defaults traditional
hostname MSK-RTR
log file /var/log/frr.log

router ospf
  ospf router-id 2.2.2.2
  network 10.100.0.0/24 area 0  # –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å (MSK)
  network 10.200.0.0/24 area 0  # –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å (YEKT)
  passive-interface eth0        # –û—Ç–∫–ª—é—á–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É Hello –ø–∞–∫–µ—Ç–æ–≤ –≤ LAN

interface wg0
  ip ospf cost 10            # –û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç –≤ –¶–û–î —á–µ—Ä–µ–∑ DC-RTR-2
  ip ospf hello-interval 10
  ip ospf dead-interval 40
    
interface wg1
  ip ospf priority 0
  ip ospf cost 50            # YEKT —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
  ip ospf hello-interval 10
  ip ospf dead-interval 40

line vty
```
YEKT-RTR
```
frr defaults traditional
hostname YEKT-RTR
log file /var/log/frr.log

router ospf
  ospf router-id 3.3.3.3
  network 10.100.0.0/24 area 0  # –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å (MSK)
  network 10.200.0.0/24 area 0  # –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å (YEKT)
  passive-interface eth0        # –û—Ç–∫–ª—é—á–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É Hello –ø–∞–∫–µ—Ç–æ–≤ –≤ LAN

interface wg0
  ip ospf cost 10            # –û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç –≤ –¶–û–î —á–µ—Ä–µ–∑ DC-RTR-1
  ip ospf hello-interval 10
  ip ospf dead-interval 40
  
interface wg1
  ip ospf priority 0
  ip ospf cost 50            # YEKT —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
  ip ospf hello-interval 10
  ip ospf dead-interval 40

line vty
```
**–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º**:
```
sudo systemctl restart frr
```
**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞**¬†–ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:    
```
    sudo frr-reload.py --test
```
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ OSPF-—Å–æ—Å–µ–¥–µ–π**:   
```
    sudo vtysh -c "show ip ospf neighbor"
```
    –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
    Neighbor ID     Pri  State      Dead Time  Address      Interface
    1.1.1.1          1  Full/DR    00:00:35   10.100.0.1   wg0
    4.4.4.4          1  Full/Backup 00:00:37  10.100.0.4   wg0
    
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤**:
```
    sudo vtysh -c "show ip route ospf"
```
     –î–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –º–∞—Ä—à—Ä—É—Ç—ã –∫–æ –≤—Å–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–º —Å–µ—Ç—è–º —Ñ–∏–ª–∏–∞–ª–æ–≤:
    O   10.15.10.0/24 [110/100] via 10.100.0.1, wg0
    O   192.168.1.0/24 [110/200] via 10.100.0.2, wg0
    O   172.16.1.0/24 [110/200] via 10.100.0.4, wg0

### 4. –î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ EIGRP –Ω–∞ —Ä–æ—É—Ç–µ—Ä–∞—Ö.
#### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è? 
   - –û–±–µ—Å–ø–µ—á—å—Ç–µ —Ä–∞–±–æ—Ç—É EIGRP —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç—É–Ω–Ω–µ–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö;
   - –û–±–µ—Å–ø–µ—á—å—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ MD5 –≤ EIGRP –ø–æ –∫–ª—é—á—É - C00lCompanY;
#### –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ FRR (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω).
–ó–∞—Ö–æ–¥–∏–º –≤ `/etc/frr/daemons` –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `eigrpd=yes`.
–ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
```
sudo systemctl restart frr
```

–°–æ–∑–¥–∞—ë–º `/etc/wireguard/wg2.conf` –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –º–µ–Ω—è—è –ø–æ—Ä—Ç –Ω–∞ 51822 –∏ –∞–¥—Ä–µ—Å —Å–µ—Ç–∏:
DC-RTR-1 
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_DC-RTR-1>
Address = 10.300.0.3/24                 # wg2 (EIGRP)
ListenPort = 51822

[Peer]
PublicKey = <–ö–õ–Æ–ß_YEKT-RTR>
Endpoint = <IP_YEKT-RTR>:51822
AllowedIPs = 10.300.0.0/24
PersistentKeepalive = 25
```
DC-RTR-2
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_DC-RTR-2>
Address = 10.300.0.4/24                 # wg2 (EIGRP)
ListenPort = 51822

[Peer]
PublicKey = <–ö–õ–Æ–ß_MSK-RTR>
Endpoint = <IP_MSK-RTR>:51822
AllowedIPs = 10.300.0.0/24
PersistentKeepalive = 25
```
MSK-RTR
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_MSK-RTR>
Address = 10.300.0.1/24                 # wg2 (EIGRP)
ListenPort = 51822

[Peer]
PublicKey = <–ö–õ–Æ–ß_DC-RTR-2>
Endpoint = <IP_DC-RTR-2>:51822
AllowedIPs = 10.300.0.0/24
PersistentKeepalive = 25
```
YEKT-RTR
```
[Interface]
PrivateKey = <–ü–†–ò–í–ê–¢–ù–´–ô_–ö–õ–Æ–ß_YEKT-RTR>
Address = 10.300.0.2/24                  # wg2 (EIGRP)
ListenPort = 51822

[Peer]
PublicKey = <–ö–õ–Æ–ß_DC-RTR-1>
Endpoint = <IP_DC-RTR-1>:51822
AllowedIPs = 10.300.0.0/24
PersistentKeepalive = 25
```

–ó–∞–ø—É—Å–∫–∞–µ–º –≤—Ç–æ—Ä–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
```
sudo systemctl enable wg-quick@wg2
sudo systemctl start wg-quick@wg2
```

–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é FRR –≤  `/etc/frr/frr.conf` –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è:
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
**DC-RTR-1**
```
frr defaults traditional
hostname DC-RTR-1
log file /var/log/frr.log

router ospf
  ospf router-id 1.1.1.1
  network 10.100.0.0/24 area 0  # –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å (MSK)
  network 10.200.0.0/24 area 0  # –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å (YEKT)
  network 192.168.1.0/24 area 0 # –°–µ—Ç—å –¶–û–î —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–µ—á–∞—Ç–∏
  passive-interface eth0        # –û—Ç–∫–ª—é—á–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É Hello –ø–∞–∫–µ—Ç–æ–≤ –≤ LAN

router eigrp 100
  network 10.300.0.0/24
  passive-interface default
  no passive-interface wg2

key chain EIGRP-KEY
  key 1
    key-string C00lCompanY

interface wg0
  ip ospf cost 10             # YEKT –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
  ip ospf hello-interval 10   # –ö–æ–ª-–≤–æ —Å–µ–∫. –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ Hello –ø–∞–∫–µ—Ç–∞
  ip ospf dead-interval 40    # –ö–æ–ª-–≤–æ —Å–µ–∫. –¥–æ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
  ip ospf retransmit-interval 5 # –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫. –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–∞–∫–µ—Ç

interface wg1
  ip ospf priority 0          # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ö–∞–æ—Ç–∏—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
  ip ospf cost 50             # MSK —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
  ip ospf hello-interval 10   # –ö–æ–ª-–≤–æ —Å–µ–∫. –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ Hello –ø–∞–∫–µ—Ç–∞
  ip ospf dead-interval 40    # –ö–æ–ª-–≤–æ —Å–µ–∫. –¥–æ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
  ip ospf retransmit-interval 5 # –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫. –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–∞–∫–µ—Ç

interface wg2
  ip eigrp 100 authentication mode md5
  ip eigrp 100 authentication key-chain wg2 EIGRP-KEY

line vty
```
DC-RTR-2
```
frr defaults traditional
hostname DC-RTR-2
log file /var/log/frr.log

router ospf
  ospf router-id 1.1.1.2
  network 10.100.0.0/24 area 0  # –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å (MSK)
  network 10.200.0.0/24 area 0  # –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å (YEKT)
  network 192.168.1.0/24 area 0 # –°–µ—Ç—å –¶–û–î —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–µ—á–∞—Ç–∏
  passive-interface eth0        # –û—Ç–∫–ª—é—á–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É Hello –ø–∞–∫–µ—Ç–æ–≤ –≤ LAN

router eigrp 100
  network 10.300.0.0/24
  passive-interface default
  no passive-interface wg2

key chain EIGRP-KEY
  key 1
    key-string C00lCompanY

interface wg0
  ip ospf cost 10            # –û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç –∫ MSK-RTR
  ip ospf hello-interval 10
  ip ospf dead-interval 40

interface wg1
  ip ospf priority 0
  ip ospf cost 50            # YEKT —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
  ip ospf hello-interval 10
  ip ospf dead-interval 40

interface wg2
  ip eigrp 100 authentication mode md5
  ip eigrp 100 authentication key-chain wg2 EIGRP-KEY

line vty
```
MSK-RTR
```
frr defaults traditional
hostname MSK-RTR
log file /var/log/frr.log

router ospf
  ospf router-id 2.2.2.2
  network 10.100.0.0/24 area 0  # –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å (MSK)
  network 10.200.0.0/24 area 0  # –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å (YEKT)
  passive-interface eth0        # –û—Ç–∫–ª—é—á–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É Hello –ø–∞–∫–µ—Ç–æ–≤ –≤ LAN

router eigrp 100
  network 10.300.0.0/24
  passive-interface default
  no passive-interface wg2

key chain EIGRP-KEY
  key 1
    key-string C00lCompanY

interface wg0
  ip ospf cost 10            # –û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç –≤ –¶–û–î —á–µ—Ä–µ–∑ DC-RTR-2
  ip ospf hello-interval 10
  ip ospf dead-interval 40
    
interface wg1
  ip ospf priority 0
  ip ospf cost 50            # YEKT —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
  ip ospf hello-interval 10
  ip ospf dead-interval 40

interface wg2
  ip eigrp 100 authentication mode md5
  ip eigrp 100 authentication key-chain wg2 EIGRP-KEY

line vty
```
YEKT-RTR
```
frr defaults traditional
hostname YEKT-RTR
log file /var/log/frr.log

router ospf
  ospf router-id 3.3.3.3
  network 10.100.0.0/24 area 0  # –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å (MSK)
  network 10.200.0.0/24 area 0  # –û—Å–Ω–æ–≤–Ω–æ–π —Ç—É–Ω–Ω–µ–ª—å (YEKT)
  passive-interface eth0        # –û—Ç–∫–ª—é—á–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É Hello –ø–∞–∫–µ—Ç–æ–≤ –≤ LAN

router eigrp 100
  network 10.300.0.0/24
  passive-interface default
  no passive-interface wg2

key chain EIGRP-KEY
  key 1
    key-string C00lCompanY

interface wg0
  ip ospf cost 10            # –û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç –≤ –¶–û–î —á–µ—Ä–µ–∑ DC-RTR-1
  ip ospf hello-interval 10
  ip ospf dead-interval 40
  
interface wg1
  ip ospf priority 0
  ip ospf cost 50            # YEKT —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
  ip ospf hello-interval 10
  ip ospf dead-interval 40

interface wg2
  ip eigrp 100 authentication mode md5
  ip eigrp 100 authentication key-chain wg2 EIGRP-KEY

line vty
```
**–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º**:
```
sudo systemctl restart frr
```

–£–±–µ–¥–∏—Ç—Å—è —á—Ç–æ –≤–∫–ª—é—á–µ–Ω–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –º–µ–∂–¥—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏:
```
sudo sysctl -w net.ipv4.ip_forward=1
```

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç¬†`51822`¬†–æ—Ç–∫—Ä—ã—Ç –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞¬†`eth0`).
```
sudo ufw allow 51822/udp
```

–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ **EIGRP-—Å–æ—Å–µ–¥–∏ –ø–æ—è–≤–∏–ª–∏—Å—å**:
```
vtysh -c "show ip eigrp neighbors"
```

–ü—Ä–æ–≤–µ—Ä—è–µ–º **–º–∞—Ä—à—Ä—É—Ç—ã EIGRP**:
```
vtysh -c "show ip route eigrp"
```

### 5. –î–ª—è –≤—ã—Ö–æ–¥–∞ –≤ —Å–µ—Ç—å ¬´–ò–Ω—Ç–µ—Ä–Ω–µ—Ç¬ª –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ PAT, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –Ω–∞ –ø—Ä–∏–≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Ä–æ—É—Ç–µ—Ä–∞—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.
#### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è?
#### –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –µ—Å—Ç—å –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ (–≤ –ø–µ—Ä–≤–æ–º –∑–∞–¥–∞–Ω–∏–∏ –º—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–ª–∏ –∞–¥—Ä–µ—Å–∞):
```
ip link show
```

–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç—É (–Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å!):
```
ip route show
```

–í–∫–ª—é—á–∏—Ç–µ –ø–µ—Ä–µ—Å—ã–ª–∫—É –ø–∞–∫–µ—Ç–æ–≤ (—á—Ç–æ–±—ã —Ä–æ—É—Ç–µ—Ä –º–æ–≥ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –º–µ–∂–¥—É —Å–µ—Ç—è–º–∏):
```
sudo sysctl -w net.ipv4.ip_forward=1
```

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:
```
sudo apt install netfilter-persistent -y
```

**–ù–∞—Å—Ç—Ä–æ–π—Ç–µ PAT** (—á—Ç–æ–±—ã —Ç—Ä–∞—Ñ–∏–∫ –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç–∏ –≤—ã—Ö–æ–¥–∏–ª —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å):
```
sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
```
- -o eth1 ‚Äî —Ç—Ä–∞—Ñ–∏–∫ –≤—ã—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
- -j MASQUERADE ‚Äî –ø–æ–¥–º–µ–Ω—è–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ IP –Ω–∞ –≤–Ω–µ—à–Ω–∏–π IP —Ä–æ—É—Ç–µ—Ä–∞.

**–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** (—á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ —Å–±—Ä–æ—Å–∏–ª–∏—Å—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏):
```
sudo iptables-save > /etc/iptables/rules.v4
# –ò–ª–∏
sudo netfilter-persistent save
```

–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –Ω–∞ –≤—Å–µ—Ö —Ä–æ—É—Ç–µ—Ä–∞—Ö.
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É:
```
ping 8.8.8.8
```

### 6. –ù–∞ –±–∞–∑–µ —Å–µ—Ä–≤–µ—Ä–∞ CLOUD-VM1 –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å OpenConnect.
#### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è?
#### –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ OpenConnect –Ω–∞ **CLOUD-VM1**:
```
sudo apt update 
sudo apt install openconnect
```
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª **vpn-failover.sh**. –í —Å–∫—Ä–∏–ø—Ç–µ —É –≤–∞—Å —É–∫–∞–∑–∞–Ω—ã ¬´–ø—É–±–ª–∏—á–Ω—ã–µ¬ª IP (–Ω–∞–ø—Ä–∏–º–µ—Ä, `188.121.90.2`). –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ **—Ä–µ–∞–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞** –≤–∞—à–∏—Ö DC-RTR-1/2, –∏ —á—Ç–æ **CLOUD-VM1** –º–æ–∂–µ—Ç –∏—Ö –ø–∏–Ω–≥–æ–≤–∞—Ç—å:
```
#!/bin/bash

# –ü—É–±–ª–∏—á–Ω—ã–µ IP-–∞–¥—Ä–µ—Å–∞ —Ä–æ—É—Ç–µ—Ä–æ–≤ (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ, –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∏–µ)
PRIMARY_ROUTER="188.121.90.2"  # DC-RTR-1
SECONDARY_ROUTER="200.100.100.20"  # DC-RTR-2
VPN_USER="vpnuser"
VPN_PASSWORD="vpnpassword"
LOG_FILE="/var/log/vpn-failover.log"
TIMEOUT=60  # –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º (1 –º–∏–Ω—É—Ç–∞)

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ä–æ—É—Ç–µ—Ä–∞
check_router() {
    ping -c 3 -W 2 $1 > /dev/null 2>&1
    echo $?
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ VPN
connect_vpn() {
    echo "$(date): –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VPN —á–µ—Ä–µ–∑ $1..." | tee -a $LOG_FILE
    pkill -f "openconnect"  # –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    echo $VPN_PASSWORD | openconnect --user=$VPN_USER --passwd-on-stdin $1 >> $LOG_FILE 2>&1 &
    sleep 5  # –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
current_router=""
while true; do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç–µ—Ä
    if [ $(check_router $PRIMARY_ROUTER) -eq 0 ]; then
        if [ "$current_router" != "$PRIMARY_ROUTER" ]; then
            echo "$(date): –û—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è..." | tee -a $LOG_FILE
            connect_vpn $PRIMARY_ROUTER
            current_router=$PRIMARY_ROUTER
        fi
    else
        # –û—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∂–¥—ë–º –º–∏–Ω—É—Ç—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
        echo "$(date): –û—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∂–¥—ë–º $TIMEOUT —Å–µ–∫—É–Ω–¥..." | tee -a $LOG_FILE
        sleep $TIMEOUT
        if [ $(check_router $PRIMARY_ROUTER) -ne 0 ] && [ $(check_router $SECONDARY_ROUTER) -eq 0 ]; then
            if [ "$current_router" != "$SECONDARY_ROUTER" ]; then
                echo "$(date): –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä..." | tee -a $LOG_FILE
                connect_vpn $SECONDARY_ROUTER
                current_router=$SECONDARY_ROUTER
            fi
        else
            echo "$(date): –û–±–∞ —Ä–æ—É—Ç–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è..." | tee -a $LOG_FILE
        fi
    fi
    sleep 10  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
done
```
–î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å:
```
chmod +x vpn-failover.sh
./vpn-failover.sh
```
–ß—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:
```
sudo cp vpn-failover.sh /usr/local/bin/
sudo nano /etc/systemd/system/vpn-failover.service
```
–î–æ–±–∞–≤—å—Ç–µ –≤ –æ—Ç–∫—Ä—ã–≤—à–∏–π—Å—è —Ñ–∞–π–ª:
```
[Unit]
Description=VPN Failover Service
After=network.target

[Service]
ExecStart=/usr/local/bin/vpn-failover.sh
Restart=always

[Install]
WantedBy=multi-user.target
```
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å:
```
sudo systemctl daemon-reload
sudo systemctl enable vpn-failover
sudo systemctl start vpn-failover
```
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ VPN-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:
```
ps aux | grep openconnect
```
### 8. –ù–∞ –º–∞—à–∏–Ω–µ DC-STORAGE —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ–∞–π–ª–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ –±–∞–∑–µ NFS
#### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è?
- **–ù–∞ DC-STORAGE** –ø–æ–¥–Ω—è—Ç—å **NFS-—Å–µ—Ä–≤–µ—Ä**, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ä–∞–∑–¥–∞–≤–∞—Ç—å —Å–µ—Ç–µ–≤—É—é –ø–∞–ø–∫—É.
- **–ù–∞ MSK-ADMINPC –∏ MSK-WORKER** —Å–¥–µ–ª–∞—Ç—å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (—á–µ—Ä–µ–∑ **pam_mount**) **—Ç–æ–ª—å–∫–æ** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ—Å—Ç–æ—è—â–∏—Ö –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π **–≥—Ä—É–ø–ø–µ**.
- –°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–ª—è—Ç—å—Å—è **–Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤**: –¥–∞–∂–µ –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å ¬´–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π¬ª –¥–æ—Å—Ç—É–ø (RW), –æ–Ω **–Ω–µ –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª—è—Ç—å** —á—É–∂–∏–µ —Ñ–∞–π–ª—ã/–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ —è–≤–ª—è–µ—Ç—Å—è. (–ü–æ–¥—Å–∫–∞–∑–∫–∞: —ç—Ç–æ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π ¬´sticky bit¬ª –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥.)
#### –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ NFS-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ **DC-STORAGE**:
```
sudo apt update
sudo apt install nfs-kernel-server
```
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–ª—É–∂–±–∞ –∑–∞–ø—É—â–µ–Ω–∞:
```
systemctl status nfs-kernel-server
```
–°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:
```
sudo mkdir -p /storage/it
sudo mkdir -p /storage/office
```
**–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –ø—Ä–∞–≤–∞ –∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤:
```
sudo chown root:IT /storage/it
sudo chown root:office /storage/office
sudo chmod 1770 /storage/it
sudo chmod 1770 /storage/office
```
–û—Ç–∫—Ä–æ–π—Ç–µ `/etc/exports`:
```
sudo nano /etc/exports
```
–î–æ–±–∞–≤—å—Ç–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```
/storage/it X.X.X.X/24(rw,sync,no_subtree_check)
/storage/office X.X.X.X/24(rw,sync,no_subtree_check)
```
–ó–∞–º–µ–Ω–∏—Ç–µ `X.X.X.X/24` –Ω–∞ —Å–µ—Ç—å, –æ—Ç–∫—É–¥–∞ –±—É–¥—É—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è MSK-ADMINPC –∏ MSK-WORKER.
> –û–ø—Ü–∏–∏:
> - `rw` ‚Äî —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å,
> - `sync` ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É,
> - `no_subtree_check` ‚Äî —É–ª—É—á—à–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å.

–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
```
sudo exportfs -ra
sudo systemctl restart nfs-kernel-server
```
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ pam_mount –Ω–∞ MSK-ADMINPC –∏ MSK-WORKER. –ù–∞ **–∫–∞–∂–¥–æ–º –∫–ª–∏–µ–Ω—Ç–µ**:
```
sudo apt update
sudo apt install libpam-mount nfs-common
```
- `libpam-mount` ‚Äî —ç—Ç–æ PAM-–º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π –º–æ–Ω—Ç–∏—Ä—É–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- `nfs-common` ‚Äî –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è NFS.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ /etc/security/pam_mount.conf.xml
```
sudo nano /etc/security/pam_mount.conf.xml
```
–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–π –±–ª–æ–∫ (–≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–∞ `<pam_mount>`):
```
<volume fstype="nfs" server="dc-storage" path="/storage/it" mountpoint="~/Desktop/IT_Folder" options="nosuid,nodev" sgrp="IT" />
<volume fstype="nfs" server="dc-storage" path="/storage/office" mountpoint="~/Desktop/Office_Folder" options="nosuid,nodev" sgrp="office" />
```
- **`sgrp=""`** –æ–∑–Ω–∞—á–∞–µ—Ç ¬´—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ—Å—Ç–æ—è—Ç –≤ –≥—Ä—É–ø–ø–µ¬ª.
- **`server="dc-storage"`** ‚Äî –∏–º—è (–∏–ª–∏ IP) NFS-—Å–µ—Ä–≤–µ—Ä–∞.
- **`path="`** ‚Äî –∫–∞–∫–∞—è –ø–∞–ø–∫–∞ —Ä–∞—Å—à–∞—Ä–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
- **`mountpoint=""`** ‚Äî –º–æ–Ω—Ç–∏—Ä—É–µ–º **–Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
- 
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è¬†`~/Desktop/company_shared`¬†—Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ–ª–∂–Ω—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ PAM). –ï—Å–ª–∏ –µ—ë –Ω–µ—Ç, —Å–æ–∑–¥–∞–π—Ç–µ –µ—ë:
```
mkdir -p ~/Desktop/IT_Folder
mkdir -p ~/Desktop/Office_Folder
```
–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ PAM
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `/etc/pam.d/common-session` (–∏–ª–∏ `common-auth` / `login` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∏—Å—Ç–µ–º—ã) –µ—Å—Ç—å —Å—Ç—Ä–æ—á–∫–∞:
```
auth     optional pam_mount.so
session  optional pam_mount.so
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã.
–ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≥—Ä—É–ø–ø—ã:
```
getent group IT
getent group office
```

**–°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É** (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç):
```
sudo groupadd IT
sudo groupadd office
```
**–î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `bober`) –≤ —ç—Ç—É –≥—Ä—É–ø–ø—É:
```
sudo usermod -aG IT bober
```
- **–ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ** –ø–æ–¥ —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞ MSK-ADMINPC –∏–ª–∏ MSK-WORKER (GUI –∏–ª–∏ SSH).
- **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ**, —á—Ç–æ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ (`~/Desktop/company_shared`) –ø–æ—è–≤–∏–ª—Å—è —Ä–µ—Å—É—Ä—Å.
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª, –∑–∞—Ç–µ–º –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª **–¥—Ä—É–≥–æ–≥–æ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –î–æ–ª–∂–Ω–æ –Ω–µ –¥–∞–≤–∞—Ç—å —É–¥–∞–ª—è—Ç—å —á—É–∂–æ–π —Ñ–∞–π–ª –±–ª–∞–≥–æ–¥–∞—Ä—è ¬´sticky bit¬ª (1770).
### 9. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
#### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è?
#### –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ **DC-STORAGE** —É—Å—Ç–∞–Ω–æ–≤–∏–º:
```
sudo apt update
sudo apt install inotify-tools rsync
```
–°–æ–∑–¥–∞–¥–∏–º —Ñ–∞–π–ª `/usr/local/bin/backup_save.sh`:
```
sudo nano /usr/local/bin/backup_save.sh
```
–í—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–¥:
```
#!/bin/bash

WATCH_DIR="/storage/office"
BACKUP_DIR="/crypto-folder"
LOG_FILE="/var/log/backup_save.log"
LOCK_FILE="/var/run/backup_save.lock"
TIMEOUT=60  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ñ–∞–π–ª–∞ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)

# ‚úÖ 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ LOCK_FILE
exec 200>"$LOCK_FILE"
if ! flock -n 200; then
    echo "$(date): ‚ö† –°–∫—Ä–∏–ø—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω! –í—Ç–æ—Ä–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω." | tee -a "$LOG_FILE"
    exit 1
fi

# ‚úÖ 2. –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –ª–∏ /crypto-folder (Crypto-LVM)
if ! mountpoint -q "$BACKUP_DIR"; then
    echo "$(date): ‚ùå –û—à–∏–±–∫–∞: $BACKUP_DIR –Ω–µ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω!" | tee -a "$LOG_FILE"
    exit 1
fi

# ‚úÖ 3. –°–ª–µ–¥–∏–º –∑–∞ —Ñ–∞–π–ª–∞–º–∏ —Å "SAVE" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ (–≤ –ª—é–±–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
inotifywait -m -r -e create,modify,moved_to --format "%w%f" "$WATCH_DIR" | while IFS= read -r FILE
do
    # ‚úÖ 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∏–º—è —Ñ–∞–π–ª–∞ "SAVE" (–≤ –ª—é–±–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
    if [[ "$(basename "$FILE")" =~ [Ss][Aa][Vv][Ee] ]]; then
        echo "$(date): üîç –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª $FILE, –æ–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏..." | tee -a "$LOG_FILE"

        elapsed=0
        while lsof "$FILE" &>/dev/null; do
            sleep 2
            (( elapsed += 2 ))
            if [[ $elapsed -ge $TIMEOUT ]]; then
                echo "$(date): ‚ö† –í–ù–ò–ú–ê–ù–ò–ï! –§–∞–π–ª $FILE –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–æ–ª—å—à–µ $TIMEOUT —Å–µ–∫—É–Ω–¥, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º." | tee -a "$LOG_FILE"
                break
            fi
        done
        
        # ‚úÖ 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π
        if [[ -f "$FILE" ]]; then
            rsync -a "$FILE" "$BACKUP_DIR/"
            if [ $? -ne 0 ]; then
                echo "$(date): ‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è $FILE" | tee -a "$LOG_FILE"
            else
                echo "$(date): ‚úÖ –§–∞–π–ª $FILE —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ $BACKUP_DIR" | tee -a "$LOG_FILE"
            fi
        else
            echo "$(date): ‚ö† –§–∞–π–ª $FILE –±—ã–ª —É–¥–∞–ª—ë–Ω –¥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —è–≤–ª—è–µ—Ç—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º." | tee -a "$LOG_FILE"
        fi
    fi
done
```
–î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:
```
sudo chmod +x /usr/local/bin/backup_save.sh
```
–ß—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Å–æ–∑–¥–∞—ë–º —Å–µ—Ä–≤–∏—Å:
```
sudo nano /etc/systemd/system/backup_save.service
```
–í—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–¥:
```
[Unit]
Description=–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤ —Å "SAVE" –≤ /storage/office –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
After=network.target

[Service]
ExecStart=/usr/local/bin/backup_save.sh
Restart=always
User=root

[Install]
WantedBy=multi-user.target
```
–ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å:
```
sudo systemctl daemon-reload
sudo systemctl enable backup_save
sudo systemctl start backup_save
```
–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å:
```
sudo systemctl status backup_save
```
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã.
**–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª** –≤ `/storage/office` —Å "SAVE" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```
touch /storage/office/my_SAVE_document.txt
```
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª **—Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª—Å—è –≤ `/crypto-folder/`**.
```
ls -l /crypto-folder/
```
**–£–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª –∏–∑ `/storage/office`** –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `/crypto-folder` –æ–Ω –æ—Å—Ç–∞–ª—Å—è.
### 10. –†–µ–∞–ª–∏–∑—É–π—Ç–µ LVM-–º–∞—Å—Å–∏–≤ –Ω–∞ DC-STORAGE
#### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è?
#### –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ DC-STORAGE –µ—Å—Ç—å —Ç—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∏—Å–∫–∞: /dev/sdb, /dev/sdc –∏ /dev/sdd. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –¥–∏—Å–∫–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –±—É–¥—É—Ç –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã. –ï—Å–ª–∏ –¥–∏—Å–∫–∏ –µ—â—ë –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º –∏–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–æ–π.

–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ç–æ–º–æ–≤ (Physical Volumes)
```
sudo pvcreate /dev/sdb
sudo pvcreate /dev/sdc
sudo pvcreate /dev/sdd
```

–û–±—ä–µ–¥–∏–Ω–∏–º —Ç—Ä–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ç–æ–º–∞ –≤ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É —Ç–æ–º–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –∏–º–µ–Ω–µ–º crypto_vg:
```
sudo vgcreate crypto_vg /dev/sdb /dev/sdc /dev/sdd
```

–°–æ–∑–¥–∞–¥–∏–º –ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ç–æ–º –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã crypto_vg —Ä–∞–∑–º–µ—Ä–æ–º 1 –ì–ë —Å –∏–º–µ–Ω–µ–º crypto_lv:
```
sudo lvcreate -L 1G -n crypto_lv crypto_vg
```
- -L 1G –∑–∞–¥–∞—ë—Ç —Ä–∞–∑–º–µ—Ä 1 –ì–ë.
- -n crypto_lv –∑–∞–¥–∞—ë—Ç –∏–º—è –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Ç–æ–º–∞.
- crypto_vg ‚Äî –∏–º—è –≥—Ä—É–ø–ø—ã —Ç–æ–º–æ–≤.

–¢–µ–ø–µ—Ä—å –∑–∞—à–∏—Ñ—Ä—É–µ–º –ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ç–æ–º —Å –ø–æ–º–æ—â—å—é cryptsetup, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç dm-crypt:
```
sudo cryptsetup luksFormat /dev/crypto_vg/crypto_lv
```
	–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç –ø–∞—Ä–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è. –í–≤–µ–¥–∏—Ç–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –µ–≥–æ.

–û—Ç–∫—Ä–æ–µ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–º, –ø—Ä–∏—Å–≤–æ–∏–≤ –µ–º—É –∏–º—è crypto_mas:
```
sudo cryptsetup luksOpen /dev/crypto_vg/crypto_lv crypto_mas
```
–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ç–æ–º –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ /dev/mapper/crypto_mas.

–°–æ–∑–¥–∞–¥–∏–º —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É ext4 –Ω–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º —Ç–æ–º–µ:
```
sudo mkfs.ext4 /dev/mapper/crypto_mas
```

–°–º–æ–Ω—Ç–∏—Ä—É–µ–º —Ç–æ–º –≤ –∫–∞—Ç–∞–ª–æ–≥ /crypto-folder.
```
sudo mount /dev/mapper/crypto_mas /crypto-folder
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ.
–°–æ–∑–¥–∞–¥–∏–º —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á–µ–≤–æ–π —Ñ–∞–π–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä, /etc/crypto_keyfile:
```
sudo dd if=/dev/urandom of=/etc/crypto_keyfile bs=1024 count=4
sudo chmod 400 /etc/crypto_keyfile
```

–î–æ–±–∞–≤–∏–º —ç—Ç–æ—Ç –∫–ª—é—á–µ–≤–æ–π —Ñ–∞–π–ª –≤ LUKS –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–æ–º–∞:
```
sudo cryptsetup luksAddKey /dev/crypto_vg/crypto_lv /etc/crypto_keyfile
```

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª /etc/crypttab, —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å —Å–∏—Å—Ç–µ–º–µ, –∫–∞–∫ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:
```
sudo nano /etc/crypttab
```

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É:
```
crypto_mas /dev/crypto_vg/crypto_lv /etc/crypto_keyfile luks
```
- crypto_mas ‚Äî –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ /dev/mapper/.
- /dev/crypto_vg/crypto_lv ‚Äî –ø—É—Ç—å –∫ –ª–æ–≥–∏—á–µ—Å–∫–æ–º—É —Ç–æ–º—É.
- /etc/crypto_keyfile ‚Äî –ø—É—Ç—å –∫ –∫–ª—é—á–µ–≤–æ–º—É —Ñ–∞–π–ª—É.
- luks ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∏–ø —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª /etc/fstab –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```
sudo nano /etc/fstab
```
–î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É:
```
/dev/mapper/crypto_mas /crypto-folder ext4 defaults 0 2
```
- /dev/mapper/crypto_mas ‚Äî —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.
- /crypto-folder ‚Äî —Ç–æ—á–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
- ext4 ‚Äî —Ç–∏–ø —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.
- defaults ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
- 0 2 ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —É—Ç–∏–ª–∏—Ç dump –∏ fsck.

–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç.
–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –ª–∏ —Ç–æ–º:
```
mount | grep /crypto-folder
```
–ï—Å–ª–∏ –≤—Å—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≤—ã —É–≤–∏–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞—é—â—É—é, —á—Ç–æ /dev/mapper/crypto_mas —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ /crypto-folder.

## **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ñ–∏—Å–∞ –≤ –ú–æ—Å–∫–≤–µ**
### 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–º–µ–Ω OpenLDAP –Ω–∞ MSK-DC1 —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É MSK-DC1, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω OpenLDAP.

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è OpenLDAP –æ–±—ã—á–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ /etc/ldap/slapd.conf –∏–ª–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ /etc/ldap/slapd.d/.

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
- –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∫–∞—Ç–∞–ª–æ–≥ /etc/ldap/slapd.d/ —Å —Ñ–∞–π–ª–∞–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (cn=config).
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ /etc/ldap/slapd.conf, —ç—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è.

- –î–ª—è –¥–æ–º–µ–Ω–∞ "company.cool" –±–∞–∑–æ–≤—ã–π DN –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å dc=company,dc=cool.
- **–î–ª—è slapd.conf:**
    - –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∏ –Ω–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É:
```
suffix "dc=company,dc=cool"
```
**–î–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:
```
ldapsearch -H ldapi:/// -Y EXTERNAL -b "cn=config" "(objectClass=olcDatabaseConfig)" olcSuffix
```
- - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –≤—ã–≤–æ–¥–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç olcSuffix: dc=company,dc=cool.

–ü—Ä–æ–≤–µ—Ä–∫–∞ Root DN. Root DN ‚Äî —ç—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –æ–±—ã—á–Ω–æ cn=admin,dc=company,dc=cool
**–î–ª—è slapd.conf:**
- –ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É:
```
rootdn "cn=admin,dc=company,dc=cool"
```
**–î–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
–í—ã–ø–æ–ª–Ω–∏—Ç–µ:
```
ldapsearch -H ldapi:/// -Y EXTERNAL -b "cn=config" "(objectClass=olcDatabaseConfig)" olcRootDN
```
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
dn: dc=company,dc=cool
objectClass: dcObject
objectClass: organization
o: Company Cool
dc: company
```
 
 **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–ª—É–∂–±—ã LDAP**
 –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–ª—É–∂–±–∞ slapd –∑–∞–ø—É—â–µ–Ω–∞:
```
 systemctl status slapd
```
–ï—Å–ª–∏ —Å–ª—É–∂–±–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –µ—ë:
```
systemctl start slapd
```

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LDAP. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:
```
ldapsearch -x -b "dc=company,dc=cool" "(objectClass=*)"
```
–ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –ø–æ–¥ –±–∞–∑–æ–≤—ã–º DN.
### 2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –¥–æ–º–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª –ø–æ –ø—É—Ç–∏ - /root/users.ldif
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª /root/users.ldif —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –î–ª—è —ç—Ç–æ–≥–æ:
```
ls -l /root/users.ldif
```
–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:
```
cat /root/users.ldif
```
–ü—Ä–∏–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ LDIF:
```
dn: uid=user1,ou=People,dc=company,dc=cool
objectClass: inetOrgPerson
uid: user1
cn: User One
sn: One
userPassword: {SSHA}hashedpassword

dn: uid=user2,ou=People,dc=company,dc=cool
objectClass: inetOrgPerson
uid: user2
cn: User Two
sn: Two
userPassword: {SSHA}hashedpassword
```
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, dc=company,dc=cool).

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–ª—É–∂–±–∞ OpenLDAP –∑–∞–ø—É—â–µ–Ω–∞.
```
systemctl status slapd
```

–î–ª—è –∏–º–ø–æ—Ä—Ç–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ LDAP (–æ–±—ã—á–Ω–æ —ç—Ç–æ cn=admin,dc=company,dc=cool). –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É ldapadd –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞ /root/users.ldif:
```
ldapadd -x -D "cn=admin,dc=company,dc=cool" -W -f /root/users.ldif
```
- -x: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–±–µ–∑ SASL).
- -D "cn=admin,dc=company,dc=cool": –£–∫–∞–∑—ã–≤–∞–µ—Ç DN –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
- -W: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤–≤–æ–¥ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
- -f /root/users.ldif: –£–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É LDIF.
–ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ –∫–æ–º–∞–Ω–¥—ã —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ LDAP. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ.

–ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–∏—Å–∫:
```
ldapsearch -x -b "ou=People,dc=company,dc=cool" "(objectClass=inetOrgPerson)"
```

–ï—Å–ª–∏ –∏–º–ø–æ—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ:
- **–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ LDIF**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ DN –∏ –∞—Ç—Ä–∏–±—É—Ç—ã –≤ —Ñ–∞–π–ª–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.
- **–°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ou=People –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å. –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, —Ç–æ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª ou_people.ldif —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:
```
dn: ou=People,dc=company,dc=cool
objectClass: organizationalUnit
ou: People
```
–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ:
```
ldapadd -x -D "cn=admin,dc=company,dc=cool" -W -f ou_people.ldif
```
**–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π.
–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —à–∞–≥ 4: (–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É ldapadd –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞ /root/users.ldif).

### 3. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã MSK-ADMINPC –∏ MSK-WORKER –≤ –¥–æ–º–µ–Ω OpenLDAP
–ù–∞ –∫–∞–∂–¥–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–∫–µ—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LDAP. –í—ã–±–æ—Ä –∫–æ–º–∞–Ω–¥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:
```
sudo apt update
sudo apt install libnss-ldap libpam-ldap ldap-utils
```
–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é —á–∞—Å—Ç—å LDAP:

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
```
  sudo dpkg-reconfigure libnss-ldap
```
–£–∫–∞–∂–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- **LDAP server URI**: ldap://<IP_MSK-DC1> (–∑–∞–º–µ–Ω–∏—Ç–µ <IP_MSK-DC1> –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π IP-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ MSK-DC1).
- **Search base**: dc=company,dc=cool (—É—Ç–æ—á–Ω–∏—Ç–µ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –µ—Å–ª–∏ –±–∞–∑–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è).
- **LDAP version**: 3.
- **Make local root Database admin**: No.
- **Does the LDAP database require login?**: No.

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ PAM –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ LDAP
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–¥—É–ª—å PAM, —á—Ç–æ–±—ã –∫–æ–º–ø—å—é—Ç–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ LDAP –¥–ª—è –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª /etc/pam.d/common-auth:
```
sudo nano /etc/pam.d/common-auth
```
–î–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Å—Ç—Ä–æ–∫–∏:
```
auth sufficient pam_ldap.so
```
–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤:
```
/etc/pam.d/common-account
/etc/pam.d/common-session
/etc/pam.d/common-password
```

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∞ –∏—Å–∫–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≥—Ä—É–ø–ø—ã –≤ LDAP:
–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª /etc/nsswitch.conf:
```
sudo nano /etc/nsswitch.conf
```
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è passwd, group –∏ shadow –≤–∫–ª—é—á–∞—é—Ç ldap:
```
passwd: files ldap
group: files ldap
shadow: files ldap
```
–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª—É–∂–±—ã –∏–ª–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä:
–ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω nscd (–∫—ç—à –∏–º–µ–Ω)
```
sudo systemctl restart nscd
```
–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LDAP:
1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä —Å —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å—å—é –∏–∑ OpenLDAP.
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π LDAP:
```
getent passwd
```
### 4. –ù–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ MSK-DC1 —Ä–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –û—Å–Ω–æ–≤–Ω–æ–π –¶–µ–Ω—Ç—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
**–®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ OpenSSL.**
–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OpenSSL. –ï—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ MSK-DC1, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:
```
sudo apt update
sudo apt install openssl
```

**–®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**
–°–æ–∑–¥–∞–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ /etc/ca –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:
```
sudo mkdir /etc/ca
sudo chmod 700 /etc/ca
```

**–®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ OpenSSL**
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª /etc/ca/openssl.cnf –¥–ª—è –∑–∞–¥–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
```
[ ca ]
default_ca = CA_default

[ CA_default ]
dir = /etc/ca
certs = $dir/certs
new_certs_dir = $dir/newcerts
database = $dir/index.txt
serial = $dir/serial
private_key = $dir/private/ca.key
certificate = $dir/certs/ca.crt
default_days = 365
default_md = sha256
policy = policy_match

[ policy_match ]
countryName = match
stateOrProvinceName = match
organizationName = optional
organizationalUnitName = optional
commonName = supplied
emailAddress = optional

[ req ]
default_bits = 2048
distinguished_name = req_distinguished_name
x509_extensions = v3_ca

[ req_distinguished_name ]
countryName = Country Name (2 letter code)
countryName_default = RU
stateOrProvinceName = State or Province Name (full name)
stateOrProvinceName_default = Moscow Oblast
localityName = Locality Name (eg, city)
localityName_default = Moscow
organizationName = Organization Name (eg, company)
organizationName_default = Cool CA
commonName = Common Name (eg, your name or your server\'s hostname)
commonName_max = 64

[ v3_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- dir = /etc/ca ‚Äî –∫–∞—Ç–∞–ª–æ–≥ —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
- countryName_default = RU ‚Äî —Å—Ç—Ä–∞–Ω–∞ "–†–æ—Å—Å–∏—è".
- stateOrProvinceName_default = Moscow Oblast ‚Äî –æ–±–ª–∞—Å—Ç—å "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è".
- localityName_default = Moscow ‚Äî –≥–æ—Ä–æ–¥ "–ú–æ—Å–∫–≤–∞".
- organizationName_default = Cool CA ‚Äî –∏–º—è —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ "Cool CA".

**–®–∞–≥ 4: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –∏ —Ñ–∞–π–ª–æ–≤**
–°–æ–∑–¥–∞–π—Ç–µ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∏ –∏ —Ñ–∞–π–ª—ã –≤ /etc/ca:
```
sudo mkdir -p /etc/ca/{certs,newcerts,private}
sudo touch /etc/ca/index.txt
sudo echo '01' > /etc/ca/serial
sudo chmod 600 /etc/ca/index.txt /etc/ca/serial
```

**–®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ CA**
–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –∫–æ—Ä–Ω–µ–≤–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
```
sudo openssl req -x509 -newkey rsa:2048 -nodes -keyout /etc/ca/private/ca.key -out /etc/ca/certs/ca.crt -days 3650 -config /etc/ca/openssl.cnf
```
–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã –≤–≤–µ–¥–∏—Ç–µ:
- **Country Name**: RU (–†–æ—Å—Å–∏—è)
- **State or Province Name**: Moscow Oblast (–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å)
- **Locality Name**: Moscow (–ú–æ—Å–∫–≤–∞)
- **Organization Name**: Cool CA
- **Common Name**: Cool CA

–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –ª–µ—Ç (3650 –¥–Ω–µ–π).

**–®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è HTTPS**
–í—Å–µ –≤–µ–±-—Å–µ—Ä–≤–∏—Å—ã –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ HTTPS —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏, –≤—ã–¥–∞–Ω–Ω—ã–º–∏ –≤–∞—à–∏–º CA. –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Apache:
1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (CSR):**
```
sudo openssl req -new -newkey rsa:2048 -nodes -keyout /etc/ssl/private/webserver.key -out /etc/ssl/certs/webserver.csr -config /etc/ca/openssl.cnf
```
–£–∫–∞–∂–∏—Ç–µ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è —Å–µ—Ä–≤–µ—Ä–∞ –≤ –ø–æ–ª–µ **Common Name**, –Ω–∞–ø—Ä–∏–º–µ—Ä, webserver.company.cool.

–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ CSR –≤–∞—à–∏–º CA:
```
sudo openssl ca -in /etc/ssl/certs/webserver.csr -out /etc/ssl/certs/webserver.crt -config /etc/ca/openssl.cnf
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Apache:** –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, /etc/apache2/sites-enabled/default-ssl.conf, –∏ –¥–æ–±–∞–≤—å—Ç–µ:
```
SSLCertificateFile /etc/ssl/certs/webserver.crt
SSLCertificateKeyFile /etc/ssl/private/webserver.key
SSLCACertificateFile /etc/ca/certs/ca.crt

```
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Apache:
```
sudo systemctl restart apache2
```
–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞.

**–®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenConnect**
OpenConnect —Ç–∞–∫–∂–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –æ—Ç –≤–∞—à–µ–≥–æ CA.
1. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ OpenConnect:**
    - –°–æ–∑–¥–∞–π—Ç–µ CSR –∏ –ø–æ–¥–ø–∏—à–∏—Ç–µ –µ–≥–æ, –∫–∞–∫ –≤ —à–∞–≥–µ 6.
    - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ OpenConnect –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (—Å–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é OpenConnect –¥–ª—è —Ç–æ—á–Ω—ã—Ö –ø—É—Ç–µ–π).
2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ OpenConnect:**
    - –ö–ª–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –¥–æ–≤–µ—Ä—è—Ç—å –≤–∞—à–µ–º—É CA. –î–ª—è —ç—Ç–æ–≥–æ –¥–æ–±–∞–≤—å—Ç–µ –∫–æ—Ä–Ω–µ–≤–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –º–∞—à–∏–Ω—ã (—Å–º. —à–∞–≥ 8).

**–®–∞–≥ 8: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ**
–ß—Ç–æ–±—ã –≤—Å–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã –≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–æ–≤–µ—Ä—è–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º –æ—Ç –≤–∞—à–µ–≥–æ CA, –¥–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª /etc/ca/certs/ca.crt –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.

`sudo mkdir /usr/local/share/ca-certificates/extra sudo cp /etc/ca/certs/ca.crt /usr/local/share/ca-certificates/extra/cool_ca.crt sudo update-ca-certificates`

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –Ω–∞ –∫–∞–∂–¥–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

---

**–®–∞–≥ 9: –ü—Ä–æ–≤–µ—Ä–∫–∞**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–µ–±-—Å–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ HTTPS –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –∫–∞–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ.
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É OpenConnect —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ –æ—Ç –≤–∞—à–µ–≥–æ CA.
- –£–¥–æ—Å—Ç–æ–≤–µ—Ä—å—Ç–µ—Å—å, —á—Ç–æ –∫–æ—Ä–Ω–µ–≤–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞ –≤—Å–µ—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö.

### 5. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –≤ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è
**–®–∞–≥ 1: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ /etc/security/time.conf**
–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ MSK-WORKER —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã:
```
sudo nano /etc/security/time.conf
```
–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Ö–æ–¥ —Ç–æ–ª—å–∫–æ —Å 09:00 –¥–æ 18:00 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ (MSK):
```
login;*;*;!Al0000-0900|1800-2400
```
- login ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–∏—Å—É –≤—Ö–æ–¥–∞.
- –ü–µ—Ä–≤—ã–π * ‚Äî –∫–æ –≤—Å–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º.
- –í—Ç–æ—Ä–æ–π * ‚Äî –∫–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
- !Al0000-0900|1800-2400 ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ—Ç –≤—Ö–æ–¥ —Å 00:00 –¥–æ 09:00 –∏ —Å 18:00 –¥–æ 24:00.
**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:** –°–∏–º–≤–æ–ª ! –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —É—Å–ª–æ–≤–∏–µ, —Ç–æ –µ—Å—Ç—å –≤—Ö–æ–¥ –∑–∞–ø—Ä–µ—â–µ–Ω –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏.
–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª –∏ –≤—ã–π–¥–∏—Ç–µ

**–®–∞–≥ 2: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –º–æ–¥—É–ª—è pam_time**
–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª /etc/pam.d/login:
```
sudo nano /etc/pam.d/login
```
–î–æ–±–∞–≤—å—Ç–µ –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É:
```
account required pam_time.so
```
- –≠—Ç–æ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞.
–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∑–∞–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª.

**–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞**
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (MSK):
```
timedatectl
```
–ï—Å–ª–∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –Ω–µ–≤–µ—Ä–Ω—ã–π, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ:
```
sudo timedatectl set-timezone Europe/Moscow
```

**–®–∞–≥4: –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ /etc/gdm3/greeter.dconf-defaults
```
sudo nano /etc/gdm3/greeter.dconf-defaults
```
–ù–∞–π–¥–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–µ–∫—Ü–∏—é [org/gnome/login-screen] –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏:
```
[org/gnome/login-screen]
banner-message-enable=true
banner-message-text='–í —Å–ª—É—á–∞–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–±–æ—á–µ–º—É –º–µ—Å—Ç—É –≤–Ω–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞ –ø–æ—á—Ç—É - admin@company.cool'
```
–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∑–∞–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª.

**–®–∞–≥5: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π**
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏—Å–ø–ª–µ–π–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä GDM:
```
sudo dpkg-reconfigure gdm3
```
–ò–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä.
### 6. MSK-ADMINPC –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ö–æ–¥–∏—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏–∑ –≥—Ä—É–ø–ø—ã IT. –û—Å—Ç–∞–ª—å–Ω—ã–º –≤—Ö–æ–¥ –∑–∞–ø—Ä–µ—â–µ–Ω
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≥—Ä—É–ø–ø–∞ IT, —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã:
```
getent group IT
```
–ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–π—Ç–µ –µ—ë:
```
sudo groupadd IT
```
–î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø, –≤ –≥—Ä—É–ø–ø—É IT:
```
sudo usermod -aG IT username
```
–ó–∞–º–µ–Ω–∏—Ç–µ username –Ω–∞ –∏–º—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø.

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Ö–æ–¥ —Ç–æ–ª—å–∫–æ —á–ª–µ–Ω–∞–º –≥—Ä—É–ø–ø—ã IT:
```
sudo nano /etc/pam.d/common-auth
```

–î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É:
```
auth required pam_succeed_if.so user ingroup IT
```
–≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –≥—Ä—É–ø–ø—ã IT.
–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∑–∞–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª.

–î–æ–±–∞–≤—å—Ç–µ —Ç—É –∂–µ —Å—Ç—Ä–æ–∫—É –≤ —Ñ–∞–π–ª /etc/pam.d/sshd, —á—Ç–æ–±—ã –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–π –≤—Ö–æ–¥.
```
auth required pam_succeed_if.so user ingroup IT
```

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ sudo –≥—Ä—É–ø–ø–µ IT
–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª /etc/sudoers –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã visudo (—ç—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ):
```
sudo visudo
```
–î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É
```
%IT ALL=(ALL) ALL
```
- %IT ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≥—Ä—É–ø–ø—É IT.
- ALL=(ALL) ALL ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ª—é–±—ã—Ö –∫–æ–º–∞–Ω–¥ –æ—Ç –∏–º–µ–Ω–∏ –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤—Å–µ—Ö —Ö–æ—Å—Ç–∞—Ö.
–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∑–∞–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª.

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ sudo
- –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å—å—é –∏–∑ –≥—Ä—É–ø–ø—ã IT.
- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É, —Ç—Ä–µ–±—É—é—â—É—é –ø—Ä–∞–≤ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```
sudo apt update
```

## **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ñ–∏—Å–∞ –≤ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–µ**
### 1. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ YEKT-BILLING —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ —Å–∞–º–æ–ø–∏—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –∑–∞ –¥–æ–±—ã—á–µ–π –≥–æ—Ä–Ω—ã—Ö –ø–æ—Ä–æ–¥, —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ YEKT-DB, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.
**1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–∏—Å—Ç–µ–º—ã**  
–û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã:
- **–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä** (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ 100%, –∑–Ω–∞—á–∏—Ç —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω):
```
top
```
    –∏–ª–∏
```
htop
```
    
- **–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å** (–µ—Å–ª–∏ –ø–∞–º—è—Ç–∏ –º–∞–ª–æ, —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å):
```
free -h
```

- **–î–∏—Å–∫–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏)**
```
iostat -xz 1
```

- **–°–µ—Ç—å (–µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏, –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏)**
```
iftop
```

**2Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–≤–µ—Ä (–µ—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª—Å—è)**
```
sudo reboot
```

**3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**  
–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –º–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –±–∞–∑–æ–π. –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–∑—É:
```
sudo -u postgres psql
```

–∏ —Å–º–æ—Ç—Ä–∏–º **—Ç–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã**:
```
SELECT * FROM pg_stat_activity;
```
–ï—Å–ª–∏ –µ—Å—Ç—å –¥–ª–∏–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –∑–Ω–∞—á–∏—Ç –±–∞–∑–∞ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞.

**4Ô∏è‚É£ –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–µ—à –±–∞–∑—ã (–µ—Å–ª–∏ PostgreSQL)**  
–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
```
sudo nano /etc/postgresql/14/main/postgresql.conf
```

–ò—â–µ–º —Å—Ç—Ä–æ–∫—É `shared_buffers`, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ `2GB`), —Å–æ—Ö—Ä–∞–Ω—è–µ–º (CTRL+X ‚Üí Y ‚Üí ENTER):
```
shared_buffers = 2GB
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–∞–∑—É:
```
sudo systemctl restart postgresql
```

–ß–∞—Å—Ç—å 2. –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
**1Ô∏è‚É£ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**
```
sudo -u postgres psql
```

**2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 15 –ª–µ—Ç**
```
SELECT * FROM mining_data WHERE extraction_date < NOW() - INTERVAL '15 years';
```

**3Ô∏è‚É£ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª (—á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å)**
```
COPY (SELECT * FROM mining_data WHERE extraction_date < NOW() - INTERVAL '15 years')
TO '/tmp/mining_backup.csv' DELIMITER ',' CSV HEADER;
```

–¢–µ–ø–µ—Ä—å –≤ —Ñ–∞–π–ª–µ `/tmp/mining_backup.csv` –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ.

**4Ô∏è‚É£ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä DC-STORAGE**
–í—ã—Ö–æ–¥–∏–º –∏–∑ –±–∞–∑—ã (`\q`) –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:
```
scp /tmp/mining_backup.csv user@DC-STORAGE:/crypto-folder/
```

–ó–∞–º–µ–Ω–∏—Ç–µ `user` –Ω–∞ –≤–∞—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**5Ô∏è‚É£ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã**
–°–Ω–æ–≤–∞ –∑–∞—Ö–æ–¥–∏–º –≤ –±–∞–∑—É (`sudo -u postgres psql`) –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º:
```
DELETE FROM mining_data WHERE extraction_date < NOW() - INTERVAL '15 years';
```

**6Ô∏è‚É£ –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**
```
VACUUM FULL;
```
–≠—Ç–æ –æ—á–∏—Å—Ç–∏—Ç "–º—É—Å–æ—Ä–Ω—ã–µ" –¥–∞–Ω–Ω—ã–µ –∏ —É—Å–∫–æ—Ä–∏—Ç —Ä–∞–±–æ—Ç—É.

**–ß–∞—Å—Ç—å 3. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ (—á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∫–∞–∂–¥—ã–π —Ä–∞–∑)**

–ß—Ç–æ–±—ã –≤—Å—ë —ç—Ç–æ –≤—ã–ø–æ–ª–Ω—è–ª–æ—Å—å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é**, —Å–æ–∑–¥–∞—ë–º —Å–∫—Ä–∏–ø—Ç.

**1Ô∏è‚É£ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä:**
```
nano /usr/local/bin/db_cleanup.sh
```

**2Ô∏è‚É£ –í—Å—Ç–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç (–∑–∞–º–µ–Ω–∏—Ç–µ `postgres` –Ω–∞ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î, –µ—Å–ª–∏ –æ–Ω–æ –¥—Ä—É–≥–æ–µ):**
```
#!/bin/bash
set -euo pipefail

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
DB_USER="postgres"
DB_NAME="mining_db"
BACKUP_DIR="/crypto-folder"
DATE=$(date +%Y-%m-%d)
EXPORT_FILE="/tmp/mining_backup_${DATE}.csv"
LOG_FILE="/var/log/db_cleanup.log"

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è –±—ç–∫–∞–ø–∞
if ! mountpoint -q "$BACKUP_DIR"; then
    log "–û—à–∏–±–∫–∞: $BACKUP_DIR –Ω–µ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
REQUIRED_SPACE_MB=100  # –ø—Ä–∏–º–µ—Ä: —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 100MB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
AVAILABLE_SPACE_MB=$(df --output=avail /tmp | tail -1)
if [ "$AVAILABLE_SPACE_MB" -lt "$REQUIRED_SPACE_MB" ]; then
    log "–û—à–∏–±–∫–∞: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö."
    exit 1
fi

log "–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö."

# –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ä—à–µ 15 –ª–µ—Ç
if ! psql -U "$DB_USER" -d "$DB_NAME" -c "\COPY (SELECT * FROM mining_data WHERE extraction_date < NOW() - INTERVAL '15 years') TO '$EXPORT_FILE' DELIMITER ',' CSV HEADER"; then
    log "–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö."
    exit 1
fi

log "–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω, —Ñ–∞–π–ª: $EXPORT_FILE."

# –ü–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä DC-STORAGE —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º rsync
if ! rsync -av --progress "$EXPORT_FILE" "DC-STORAGE:$BACKUP_DIR/"; then
    log "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä DC-STORAGE."
    exit 1
fi

log "–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω –Ω–∞ DC-STORAGE."

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã
if ! psql -U "$DB_USER" -d "$DB_NAME" -c "DELETE FROM mining_data WHERE extraction_date < NOW() - INTERVAL '15 years';"; then
    log "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã."
    exit 1
fi

log "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–æ."

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
if ! psql -U "$DB_USER" -d "$DB_NAME" -c "VACUUM FULL;"; then
    log "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ VACUUM FULL."
    exit 1
fi

log "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

# –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
rm -f "$EXPORT_FILE"
log "–í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª—ë–Ω. –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ."

```

**3Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –≤—ã—Ö–æ–¥–∏–º (CTRL+X ‚Üí Y ‚Üí ENTER)**

**4Ô∏è‚É£ –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º:**
```
chmod +x /usr/local/bin/db_cleanup.sh
```

**5Ô∏è‚É£ –î–æ–±–∞–≤–ª—è–µ–º –≤ cron (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é)**
```
crontab -e
```

–î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É:
```
0 2 * * 1 /usr/local/bin/db_cleanup.sh >> /var/log/db_cleanup.log 2>&1
```
–≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç —Å–∫—Ä–∏–ø—Ç **–∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 2:00 –Ω–æ—á–∏**.

### 2. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ YEKT-DB —É–∂–µ –µ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä Zabbix:
    - –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫ —Å–µ—Ä–≤–µ—Ä—É HTTPS;
    - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ Zabbix —Ç–∞–∫, —á—Ç–æ –≤ —Å–ª—É—á–∞–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ CPU –±–æ–ª—å—à–µ —á–µ–º –Ω–∞ 80% –∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∏—Å–∫–∞ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 90%, Zabbix –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∏—Å–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –ø–æ—á—Ç—É - **admin@company.cool**.
    - –ø–æ—á—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç admin@company.cool –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ MSK-ADMINPC –¥–ª—è –¥–æ–º–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - admin_infra (–∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–π –∏–∑ LDIF-—Ñ–∞–π–ª–∞)

